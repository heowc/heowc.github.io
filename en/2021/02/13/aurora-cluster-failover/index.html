<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">AWS Aurora DB Cluster - FailOver 대응하기 | 허원철의 개발 블로그</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://heowc.dev/en/2021/02/13/aurora-cluster-failover"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="ko"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="google-site-verification" content="1Ix_vZKEleqqZQsobMMrFR0_bX9Bj-nLZnE6QKSppDA"><meta data-rh="true" name="naver-site-verification" content="c8078357cb88dc72964f9089507aaf7bb0dd1b3b"><meta data-rh="true" property="og:title" content="AWS Aurora DB Cluster - FailOver 대응하기 | 허원철의 개발 블로그"><meta data-rh="true" name="description" content="최근 회사에서 오로라디비를 스케일 업하기 위해서 failover 테스트를 하다가 있었던 이슈를 공유합니다."><meta data-rh="true" property="og:description" content="최근 회사에서 오로라디비를 스케일 업하기 위해서 failover 테스트를 하다가 있었던 이슈를 공유합니다."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2021-02-13T17:19:00.000Z"><meta data-rh="true" property="article:tag" content="aws,aurora,failover"><link data-rh="true" rel="icon" href="/en/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://heowc.dev/en/2021/02/13/aurora-cluster-failover"><link data-rh="true" rel="alternate" href="https://heowc.dev/2021/02/13/aurora-cluster-failover" hreflang="ko"><link data-rh="true" rel="alternate" href="https://heowc.dev/en/2021/02/13/aurora-cluster-failover" hreflang="en"><link data-rh="true" rel="alternate" href="https://heowc.dev/2021/02/13/aurora-cluster-failover" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://Z12OUS9993-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://heowc.dev/en/2021/02/13/aurora-cluster-failover","mainEntityOfPage":"https://heowc.dev/en/2021/02/13/aurora-cluster-failover","url":"https://heowc.dev/en/2021/02/13/aurora-cluster-failover","headline":"AWS Aurora DB Cluster - FailOver 대응하기","name":"AWS Aurora DB Cluster - FailOver 대응하기","description":"최근 회사에서 오로라디비를 스케일 업하기 위해서 failover 테스트를 하다가 있었던 이슈를 공유합니다.","datePublished":"2021-02-13T17:19:00.000Z","author":[],"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://heowc.dev/en/","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/en/rss.xml" title="허원철의 개발 블로그 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/en/atom.xml" title="허원철의 개발 블로그 Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8JEMHFKCWF"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8JEMHFKCWF",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="허원철의 개발 블로그" href="/en/opensearch.xml">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5618198218047336" crossorigin="anonymous"></script><link rel="stylesheet" href="/en/assets/css/styles.4f168648.css">
<script src="/en/assets/js/runtime~main.cce1e684.js" defer="defer"></script>
<script src="/en/assets/js/main.fdbd1e1b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="//avatars.githubusercontent.com/u/22594101?s=460&amp;v=4" alt="Avatar" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="//avatars.githubusercontent.com/u/22594101?s=460&amp;v=4" alt="Avatar" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">허원철의 개발 블로그</b></a><a class="navbar__item navbar__link" href="/en/tags">Tags</a><a class="navbar__item navbar__link" href="/en/archive">Archive</a><a href="https://heowc.dev/programming-study/repo/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Study<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/heowc" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/2023/04/07/improve-spring-integration-test-for-mock">SpringBoot 테스트 개선해보기 (feat. mock)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/2022/04/11/serverless-image-handler">serverless-image-handler</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/2022/02/22/blog-migrate-to-docusaurus-from-hexo">블로그 마이그레이션 (feat. docusaurus)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/2021/12/28/2021-develop-retrospection">2021년 개발 회고</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/2021/11/27/hibernate-nativequery-bug-with-postgres">Hibernate NativeQuery HHH-14778 issue (with Postgres)</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="title_f1Hy">AWS Aurora DB Cluster - FailOver 대응하기</h1><div class="container_mt6G margin-vert--md"><time datetime="2021-02-13T17:19:00.000Z">February 13, 2021</time> · <!-- -->7 min read</div></header><div id="__blog-post-container" class="markdown"><p>최근 회사에서 오로라디비를 스케일 업하기 위해서 failover 테스트를 하다가 있었던 이슈를 공유합니다.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="진행-플로우">진행 플로우<a class="hash-link" aria-label="Direct link to 진행 플로우" title="Direct link to 진행 플로우" href="/en/2021/02/13/aurora-cluster-failover#진행-플로우">​</a></h4>
<p>진행했던 플로우는 다음과 같습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">slave 스케일 업</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">slave를 master로 승격(failover)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">slave 스케일 업</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="에러-발생">에러 발생<a class="hash-link" aria-label="Direct link to 에러 발생" title="Direct link to 에러 발생" href="/en/2021/02/13/aurora-cluster-failover#에러-발생">​</a></h4>
<p><strong>1번의 경우,</strong> 인스턴스가 내려갔다 올라오기 때문에 잠시 동안 slave를 사용할 수 없게 됩니다. 하지만, cluster end-point를 사용하게 되면 자동적으로 slave로 가던 트래픽이 master를 바라보게 됩니다.
<strong>2번의 경우,</strong> master와 slave가 바뀌니 아주 잠깐의 순단이 있겠지만 이는 내부적으로 커넥션이 다시 맺어 정상 동작할것이라고 생각했습니다.</p>
<p>하지만... 2번을 진행함과 동시에 서버에서는 다음과 같은 예외가 출력되고 있었습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">The MySQL server is running with the --read-only option so it cannot execute this statement</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>자동으로 커낵션을 다시 맺어줄꺼란 생각이 틀렸고, 구글링을 통해 다음과 같은 게시물을 찾을 수 있었습니다.
(참고: <a href="https://aws.amazon.com/ko/premiumsupport/knowledge-center/aurora-mysql-db-cluser-read-only-error/" target="_blank" rel="noopener noreferrer">https://aws.amazon.com/ko/premiumsupport/knowledge-center/aurora-mysql-db-cluser-read-only-error/</a>)</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="해결방법">해결방법<a class="hash-link" aria-label="Direct link to 해결방법" title="Direct link to 해결방법" href="/en/2021/02/13/aurora-cluster-failover#해결방법">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="1-클러스터-라이터-엔드포인트-활용">1. 클러스터 라이터 엔드포인트 활용<a class="hash-link" aria-label="Direct link to 1. 클러스터 라이터 엔드포인트 활용" title="Direct link to 1. 클러스터 라이터 엔드포인트 활용" href="/en/2021/02/13/aurora-cluster-failover#1-클러스터-라이터-엔드포인트-활용">​</a></h5>
<p>우리 서비스에서는 이미 cluster endpoint를 사용하고 있기 때문에 해당이 안되는 내용이였습니다. 혹시 instance endpoint를 사용하고 있다면 cluster endpoint를 사용하길 권장드립니다.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="2-dns를-과도하게-캐시하지-않음">2. DNS를 과도하게 캐시하지 않음<a class="hash-link" aria-label="Direct link to 2. DNS를 과도하게 캐시하지 않음" title="Direct link to 2. DNS를 과도하게 캐시하지 않음" href="/en/2021/02/13/aurora-cluster-failover#2-dns를-과 도하게-캐시하지-않음">​</a></h5>
<p>이번에 알게된 사실이지만 JVM 애플리케이션이 실행된 이우에 DNS 캐시하게 됩니다. 이는 jdk 구현체 마다 옵션이 다르다고 알고 있지만 오라클 jdk를 사용하는 경우는 이를 무기한으로 가지게 됩니다. 변경이 되지 않는다는 얘기죠. 그래서 우리는 <code>networkaddress.cache.ttl</code>를 추가하여 테스트 해보기로 했습니다만... 동일한 예외가 발생했습니다.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="3-스마트-드라이버-사용">3. 스마트 드라이버 사용<a class="hash-link" aria-label="Direct link to 3. 스마트 드라이버 사용" title="Direct link to 3. 스마트 드라이버 사용" href="/en/2021/02/13/aurora-cluster-failover#3-스마트-드라이버-사용">​</a></h5>
<p>마지막 방법으로 커넥터를 변경하는 것입니다. 현재 사용 중인 커넥터는 <code>mysql-connector</code>였고, 이를 <code>mariadb-connector</code>로 변경하는 것이였습니다. 조금 더 찾아보니 <code>mariadb-connector</code>에는 <code>mysql-connector</code>와 달리 failover에 대한 대응이 가능한 옵션을 제공해주고 있었습니다.
(참고: <a href="https://mariadb.com/kb/en/failover-and-high-availability-with-mariadb-connector-j/#specifics-for-amazon-aurora" target="_blank" rel="noopener noreferrer">https://mariadb.com/kb/en/failover-and-high-availability-with-mariadb-connector-j/#specifics-for-amazon-aurora</a>)</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jdbc:mysql:aurora:.....</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>AWS 커뮤니티에도 질문을 남겼지만 대다수의 분들이 <code>mariadb-connector</code>로 변경해서 해결했다는 것을 알 수 있었습니다.</p>
<p>그리고 이제는 마지막일거라고 생각하고 테스트를 했고 성공했습니다..! 조금 더 코드를 살펴보니 실패 시에 내부적으로 커낵션을 다시 맺는 과정이 포함되어 있는 것을 알 수 있었습니다.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="또-다른-이슈">또 다른 이슈<a class="hash-link" aria-label="Direct link to 또 다른 이슈" title="Direct link to 또 다른 이슈" href="/en/2021/02/13/aurora-cluster-failover#또-다른-이슈">​</a></h4>
<p>커낵션에 대한 부분은 해결했지만... 다른 예외가 발생합니다. connector를 변경함으로써 발생한 문제인데요. 이런 문제가 발생할 수 있구나 했습니다.</p>
<p>안타까운 현실이지만 서비스에서 <strong>SQL Mapper인 <code>Mybatis</code>를 사용</strong>하며, <strong>datetime의 컬럼 값을 String으로 받는 케이스</strong>가 있었습니다. 기존 <code>mysql-connector</code>에서는 이 값이 <code>2021-02-07 17:19:00</code>으로 할당 됐었다면, <code>mariadb-connector</code>를 사용하면 <code>2021-02-07 17:19:00.0</code>으로 할당 됩니다.</p>
<blockquote>
<p>AS-IS:</p>
<ul>
<li>mysql-connector</li>
<li>2021-02-07 17:19:00</li>
</ul>
<p>TO-BE</p>
<ul>
<li>mariadb-connector</li>
<li>2021-02-07 17:19:00.0</li>
</ul>
</blockquote>
<p>어떻게 된 일까요? 잠깐 코드를 디버깅해보니 이는 커넥터 구현체의 차이에서 서로 다른 응답을 주는 것을 알 수 있었습니다.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="mysql-connector">mysql-connector<a class="hash-link" aria-label="Direct link to mysql-connector" title="Direct link to mysql-connector" href="/en/2021/02/13/aurora-cluster-failover#mysql-connector">​</a></h5>
<ul>
<li><a href="https://github.com/mysql/mysql-connector-j/blob/18bbd5e68195d0da083cbd5bd0d05d76320df7cd/src/main/core-impl/java/com/mysql/cj/result/StringValueFactory.java#L95...L98" target="_blank" rel="noopener noreferrer">https://github.com/mysql/mysql-connector-j/blob/18bbd5e68195d0da083cbd5bd0d05d76320df7cd/src/main/core-impl/java/com/mysql/cj/result/StringValueFactory.java#L95...L98</a></li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createFromTimestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">InternalTimestamp</span><span class="token plain"> its</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%s %s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createFromDate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">its</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 2021-02-07 17:19:00</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">createFromTime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">InternalTime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">its</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getHours</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> its</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMinutes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> its</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getSeconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> its</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getNanos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> its</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getScale</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="mariadb-connector">mariadb-connector<a class="hash-link" aria-label="Direct link to mariadb-connector" title="Direct link to mariadb-connector" href="/en/2021/02/13/aurora-cluster-failover#mariadb-connector">​</a></h5>
<ul>
<li><a href="https://github.com/mariadb-corporation/mariadb-connector-j/blob/2.7.1/src/main/java/org/mariadb/jdbc/internal/com/read/resultset/rowprotocol/TextRowProtocol.java#L216...L225" target="_blank" rel="noopener noreferrer">https://github.com/mariadb-corporation/mariadb-connector-j/blob/2.7.1/src/main/java/org/mariadb/jdbc/internal/com/read/resultset/rowprotocol/TextRowProtocol.java#L216...L225</a></li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">DATETIME</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Timestamp</span><span class="token plain"> timestamp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getInternalTimestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">columnInfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cal</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> timeZone</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timestamp </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lastValueNull </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">BIT_LAST_ZERO_DATE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lastValueNull </span><span class="token operator" style="color:#393A34">^=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">BIT_LAST_ZERO_DATE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pos</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> length</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">StandardCharsets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">UTF_8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 2021-02-07 17:19:00.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>대략적으로 정리하자면, <code>mysql-connector</code>는 내부적으로 String.format을 사용하여 <code>YYYY-MM-dd HH:mm:ss</code> 형태를 만들어주는 듯 보입니다. 반면, <code>mariadb-connector</code>는 <code>Timestamp.toString()</code>을 사용합니다.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="mybatis---typehandler">mybatis - typeHandler<a class="hash-link" aria-label="Direct link to mybatis - typeHandler" title="Direct link to mybatis - typeHandler" href="/en/2021/02/13/aurora-cluster-failover#mybatis---typehandler">​</a></h5>
<p>우리는 이것 때문에 비즈니스 로직을 건드는 것은 크리티컬한 이슈가 발생할 수 있다고 판단하여 고민 끝에 Mybatis의 <a href="https://mybatis.org/mybatis-3/ko/configuration.html#typeHandlers" target="_blank" rel="noopener noreferrer">TypeHandler</a>를 이용하기로 했습니다. (JPA를 사용하는 경우, <a href="https://www.baeldung.com/jpa-attribute-converters" target="_blank" rel="noopener noreferrer"><code>AttributeConverter</code></a>  를 사용할 수 있습니다.)</p>
<p>이미 기본적인 typeHandler로 구현되어 있는 것을 어느정도 커스텀하면 비즈니스 로직을 수정하지 않고도 간단히 커넥터 변경 이슈를 수정할 수 있었고, 성공적으로 테스트를 완료할 수 있었습니다.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/en/tags/aws">aws</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/en/tags/aurora">aurora</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/en/tags/failover">failover</a></li></ul></div></div></footer></article><div id="disqus_thread"></div><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/en/2021/05/23/amazone-linux-log-issue"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Amazon Linux에서 /var/log가 꽉차는 이슈</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/en/2020/12/27/2020-develop-retrospection"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">2020년 개발 회고</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 heowc, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>