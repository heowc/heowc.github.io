<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">JpaCursorItemReader 제대로 써보기 | 허원철의 개발 블로그</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://heowc.dev/en/2024/10/20/spring-batch-jpacursoritemreader"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="ko"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="google-site-verification" content="1Ix_vZKEleqqZQsobMMrFR0_bX9Bj-nLZnE6QKSppDA"><meta data-rh="true" name="naver-site-verification" content="c8078357cb88dc72964f9089507aaf7bb0dd1b3b"><meta data-rh="true" property="og:title" content="JpaCursorItemReader 제대로 써보기 | 허원철의 개발 블로그"><meta data-rh="true" name="description" content="JpaCursorItemReader 관련하여 많은 글이 있습니다."><meta data-rh="true" property="og:description" content="JpaCursorItemReader 관련하여 많은 글이 있습니다."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-10-20T21:30:00.000Z"><meta data-rh="true" property="article:tag" content="spring-batch,JpaCursorItemReader,hibernate,jpa-2.2"><link data-rh="true" rel="icon" href="/en/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://heowc.dev/en/2024/10/20/spring-batch-jpacursoritemreader"><link data-rh="true" rel="alternate" href="https://heowc.dev/2024/10/20/spring-batch-jpacursoritemreader" hreflang="ko"><link data-rh="true" rel="alternate" href="https://heowc.dev/en/2024/10/20/spring-batch-jpacursoritemreader" hreflang="en"><link data-rh="true" rel="alternate" href="https://heowc.dev/2024/10/20/spring-batch-jpacursoritemreader" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://Z12OUS9993-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://heowc.dev/en/2024/10/20/spring-batch-jpacursoritemreader","mainEntityOfPage":"https://heowc.dev/en/2024/10/20/spring-batch-jpacursoritemreader","url":"https://heowc.dev/en/2024/10/20/spring-batch-jpacursoritemreader","headline":"JpaCursorItemReader 제대로 써보기","name":"JpaCursorItemReader 제대로 써보기","description":"JpaCursorItemReader 관련하여 많은 글이 있습니다.","datePublished":"2024-10-20T21:30:00.000Z","author":[],"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://heowc.dev/en/","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/en/rss.xml" title="허원철의 개발 블로그 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/en/atom.xml" title="허원철의 개발 블로그 Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8JEMHFKCWF"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8JEMHFKCWF",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="허원철의 개발 블로그" href="/en/opensearch.xml">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5618198218047336" crossorigin="anonymous"></script><link rel="stylesheet" href="/en/assets/css/styles.4f168648.css">
<script src="/en/assets/js/runtime~main.386fd3f7.js" defer="defer"></script>
<script src="/en/assets/js/main.a7fbf5e2.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="//avatars.githubusercontent.com/u/22594101?s=460&amp;v=4" alt="Avatar" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="//avatars.githubusercontent.com/u/22594101?s=460&amp;v=4" alt="Avatar" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">허원철의 개발 블로그</b></a><a class="navbar__item navbar__link" href="/en/tags">Tags</a><a class="navbar__item navbar__link" href="/en/archive">Archive</a><a href="https://heowc.dev/programming-study/repo/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Study<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/heowc" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/en/2024/10/20/spring-batch-jpacursoritemreader">JpaCursorItemReader 제대로 써보기</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/2023/04/07/improve-spring-integration-test-for-mock">SpringBoot 테스트 개선해보기 (feat. mock)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/2022/04/11/serverless-image-handler">serverless-image-handler</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/2022/02/22/blog-migrate-to-docusaurus-from-hexo">블로그 마이그레이션 (feat. docusaurus)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/2021/12/28/2021-develop-retrospection">2021년 개발 회고</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="title_f1Hy">JpaCursorItemReader 제대로 써보기</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-10-20T21:30:00.000Z">October 20, 2024</time> · <!-- -->6 min read</div></header><div id="__blog-post-container" class="markdown"><p>JpaCursorItemReader 관련하여 많은 글이 있습니다.</p>
<p>제대로된 cursor 구현이 안되어 있어 그 효과를 누리지 못 한다고 하네요.
이 말을 듣고 꽤나 시간이 지났는데, 아직도 그럴까? 싶어서 확인해보고 싶었습니다.
제가 만들고 있는 서비스에도 써야하는 상황에 놓이기도 했구요.</p>
<p>그 동안 jpa 스펙도, hibernate도, spring-batch도 많은 변화가 있었을테니까요.</p>
<p>결론 부터 얘기하면 펙트는, <code>아직은 이전과 동일하다. 다만, 곧 개선될 예정이다.</code> 입니다.</p>
<p>왜 그런지 살펴볼까요? (spring-batch 5.2-m2 기준)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="jpa-22-스펙-추가">jpa 2.2 스펙 추가<a class="hash-link" aria-label="Direct link to jpa 2.2 스펙 추가" title="Direct link to jpa 2.2 스펙 추가" href="/en/2024/10/20/spring-batch-jpacursoritemreader#jpa-22-스펙-추가">​</a></h2>
<p><a href="https://download.oracle.com/otn-pub/jcp/persistence-2_2-mrel-spec/JavaPersistence.pdf?AuthParam=1729391161_518d0264462d9cfe3aed562ebae8d20d" target="_blank" rel="noopener noreferrer">https://download.oracle.com/otn-pub/jcp/persistence-2_2-mrel-spec/JavaPersistence.pdf?AuthParam=1729391161_518d0264462d9cfe3aed562ebae8d20d</a></p>
<p>위 내용을 살펴보면, <code>Query.getResultStream()</code>가 추가되었습니다.
이제야 JdbcCursor 나 HibernateCursor 방식으로 cursor를 구현하지 않아도 jpa 자체에 스펙이 추가된 것 같네요.</p>
<p>default 메소드를 아래와 같이 구현을 해두었는데요. 해당 구현을 한 <code>hibernate-orm</code>은 버전은 어떻게 될까요?</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token class-name">Stream</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getResultStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getResultList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">stream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="hibernate-orm-55">hibernate-orm 5.5<a class="hash-link" aria-label="Direct link to hibernate-orm 5.5" title="Direct link to hibernate-orm 5.5" href="/en/2024/10/20/spring-batch-jpacursoritemreader#hibernate-orm-55">​</a></h2>
<p><code>5.5.Fianl</code> 릴리즈 노트를 찾아보면, jpa 2.2 스펙을 지원한다고 명시되어 있습니다.
(항상 hibernate 릴리즈 노트는 보기가 좀 불편한건 저만 그런가요? :thinking_face: )</p>
<p><a href="https://in.relation.to/2021/06/02/hibernate-orm-550-final-release/" target="_blank" rel="noopener noreferrer">https://in.relation.to/2021/06/02/hibernate-orm-550-final-release/</a></p>
<p>문서의 예시를 찾아봐도 jpa 2.2 스펙에서 언급했던 <code>getResultStream()</code>를 활용하는 것을 볼 수 있습니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Person</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> persons </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> entityManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createQuery</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token string" style="color:#e3116c">&quot;select p &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token string" style="color:#e3116c">&quot;from Person p &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token string" style="color:#e3116c">&quot;where p.name like :name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Person</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setParameter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;J%&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getResultStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// &lt;---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">skip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">limit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">collect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token class-name">Collectors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><a href="https://docs.jboss.org/hibernate/orm/5.5/userguide/html_single/Hibernate_User_Guide.html#jpql-api-stream" target="_blank" rel="noopener noreferrer">https://docs.jboss.org/hibernate/orm/5.5/userguide/html_single/Hibernate_User_Guide.html#jpql-api-stream</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="spring-batch--과거-jpacursoritemreader">spring-batch / 과거 JpaCursorItemReader<a class="hash-link" aria-label="Direct link to spring-batch / 과거 JpaCursorItemReader" title="Direct link to spring-batch / 과거 JpaCursorItemReader" href="/en/2024/10/20/spring-batch-jpacursoritemreader#spring-batch--과거-jpacursoritemreader">​</a></h2>
<p>그렇다면, <code>JpaCursorItemReader</code>가 처음 도입된 시점에는 어땟길래 문제가 있던 걸까요?</p>
<p><a href="https://github.com/spring-projects/spring-batch/commit/41854008e8c1f22cd2f7d4f95326b0a3f159b58b" target="_blank" rel="noopener noreferrer">https://github.com/spring-projects/spring-batch/commit/41854008e8c1f22cd2f7d4f95326b0a3f159b58b</a>
<a href="https://github.com/spring-projects/spring-batch/blob/41854008e8c1f22cd2f7d4f95326b0a3f159b58b/build.gradle#L73" target="_blank" rel="noopener noreferrer">https://github.com/spring-projects/spring-batch/blob/41854008e8c1f22cd2f7d4f95326b0a3f159b58b/build.gradle#L73</a></p>
<p>hibernate-orm 버전이 <code>5.4.20.Final</code> 이였습니다.
hibernate-orm 기준 <code>5.5.x</code>에 도입이 되었으나, 미리 구현되어 되었다는 것을 볼 수 있는데요.
이슈를 따라 올라가봐도 2.2 스펙에 미리 대응하기 위한 작업으로 보이기도 합니다.</p>
<p>그래서 <code>getResultStream</code>을 써도 default 메소드처럼 list.stream()을 쓰는 방식으로 밖에 동작을 안했을 거라 판단됩니다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="그렇다면-jpacursoritemreader-이제는-정말-괜찮을까">그렇다면, JpaCursorItemReader 이제는 정말 괜찮을까?<a class="hash-link" aria-label="Direct link to 그렇다면, JpaCursorItemReader 이제는 정말 괜찮을까?" title="Direct link to 그렇다면, JpaCursorItemReader 이제는 정말 괜찮을까?" href="/en/2024/10/20/spring-batch-jpacursoritemreader#그렇다면-jpacursoritemreader-이제는-정말-괜찮을까">​</a></h2>
<p>마지막 릴리즈 버전 (5.1.2)에서는 <code>6.3.2.Final</code> 입니다.
<a href="https://github.com/spring-projects/spring-batch/blob/v5.1.2/pom.xml#L81" target="_blank" rel="noopener noreferrer">https://github.com/spring-projects/spring-batch/blob/v5.1.2/pom.xml#L81</a>
(그런데 build tool을 gradle에서 maven으로 변경된 것 같은데, 이런 경우는 처음 보네요...)</p>
<p>간단한 예제로 확인해보기로 했습니다.</p>
<p><a href="https://github.com/heowc-scratch/spring-batch-5_x-JpaCursorItemReader" target="_blank" rel="noopener noreferrer">https://github.com/heowc-scratch/spring-batch-5_x-JpaCursorItemReader</a></p>
<p>MySQL 8.x를 도커로 구성하고 간단한 엔티티 (user)를 만들어서 10만 row 정도 미리 넣어두고 이를 <code>JpaCursorItemReader</code>로 조회해보았습니다.
결과는 초반에 언급한 것 처럼, 예상과 다르게 메모리가 꽤나 튀는 것을 볼 수 있습니다.</p>
<p><img decoding="async" loading="lazy" src="https://github.com/heowc-scratch/spring-batch-5_x-JpaCursorItemReader/raw/main/no_fetchszie.png" alt="img no-fetchsize" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="왜-그런걸까">왜 그런걸까?<a class="hash-link" aria-label="Direct link to 왜 그런걸까?" title="Direct link to 왜 그런걸까?" href="/en/2024/10/20/spring-batch-jpacursoritemreader#왜-그런걸까">​</a></h3>
<p>확인해볼 문제는 jdbc-driver 레벨까지 내려가 <code>fetchSize</code> 가 정상적으로 설정이 되었고, 작동하고 있느냐를 봐야합니다.
자세한 내용은 예전에 다룬 적이 있어서 해당 게시글로 대신 하겠습니다.</p>
<ul>
<li><a href="https://heowc.dev/2019/02/09/using-mysql-jdbc-to-handle-large-table-1" target="_blank" rel="noopener noreferrer">https://heowc.dev/2019/02/09/using-mysql-jdbc-to-handle-large-table-1</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="그러면-fetchsize를-어떻게-설정하나">그러면 fetchSize를 어떻게 설정하나..?<a class="hash-link" aria-label="Direct link to 그러면 fetchSize를 어떻게 설정하나..?" title="Direct link to 그러면 fetchSize를 어떻게 설정하나..?" href="/en/2024/10/20/spring-batch-jpacursoritemreader#그러면-fetchsize를-어떻게-설정하나">​</a></h3>
<p>이전에 언급한 것 처럼 driver 설정을 넣는 방법도 있지만, spring-batch에서도 관련 이슈를 언급된 부분이 있습니다.</p>
<ul>
<li><a href="https://github.com/spring-projects/spring-batch/issues/4479" target="_blank" rel="noopener noreferrer">https://github.com/spring-projects/spring-batch/issues/4479</a></li>
</ul>
<p>저는 직접적으로 많이 써보지 않았지만, hint를 설정하면 가능한데 이걸 지원해주지 않는 걸로 보입니다.
그런데 최근에 우리나라 분이 해당 이슈를 해결해주셨습니다..!
감사하게도 요즘 우리나라 분들도 오픈소스에 관심이 많이지고 있어서 그런지 스프링 프로젝트에도 간간히 보이는 것 같아요 <!-- -->🙏</p>
<p>해당 버전은 5.2.0-M1에 추가되었으며, 아직 공식 릴리즈 되진 않았습니다.</p>
<p><a href="https://github.com/spring-projects/spring-batch/releases/tag/v5.2.0-M1" target="_blank" rel="noopener noreferrer">https://github.com/spring-projects/spring-batch/releases/tag/v5.2.0-M1</a></p>
<p>마일스톤 일정에 의하면 2024.11.20 예정인데 당장 써야하는 분들은 쓸 수 없는 상황입니다.
그렇다고 마일스톤 버전을 쓰기엔 조금 위험할 수 도 있습니다.</p>
<p><a href="https://github.com/spring-projects/spring-batch/milestone/145" target="_blank" rel="noopener noreferrer">https://github.com/spring-projects/spring-batch/milestone/145</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hintsettablejpacursoritemreader-임시-구현-및-결과">HintSettableJpaCursorItemReader 임시 구현 및 결과<a class="hash-link" aria-label="Direct link to HintSettableJpaCursorItemReader 임시 구현 및 결과" title="Direct link to HintSettableJpaCursorItemReader 임시 구현 및 결과" href="/en/2024/10/20/spring-batch-jpacursoritemreader#hintsettablejpacursoritemreader-임시-구현-및-결과">​</a></h3>
<p>그래서 저는 만들어주신 hint를 추가한 reader를 임시로 <code>HintSettableJpaCursorItemReader</code>를 만들어서 릴리즈 전까지 쓰려고 합니다.</p>
<ul>
<li><a href="https://github.com/heowc-scratch/spring-batch-5_x-JpaCursorItemReader/blob/main/src/main/java/org/springframework/batch/item/database/HintSettableJpaCursorItemReader.java" target="_blank" rel="noopener noreferrer">https://github.com/heowc-scratch/spring-batch-5_x-JpaCursorItemReader/blob/main/src/main/java/org/springframework/batch/item/database/HintSettableJpaCursorItemReader.java</a></li>
</ul>
<p>테스트 해본 결과는 다음과 같습니다.</p>
<p><img decoding="async" loading="lazy" src="https://github.com/heowc-scratch/spring-batch-5_x-JpaCursorItemReader/raw/main/fetchsize.png" alt="img fetchsize" class="img_ev3q"></p>
<p>확실히 fetchSize 여부가 heap 메모리 부분에서 많은 차이가 나는 것을 볼 수 있습니다.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/en/tags/spring-batch">spring-batch</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/en/tags/jpa-cursor-item-reader">JpaCursorItemReader</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/en/tags/hibernate">hibernate</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/en/tags/jpa-2-2">jpa-2.2</a></li></ul></div></div></footer></article><div id="disqus_thread"></div><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/en/2023/04/07/improve-spring-integration-test-for-mock"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">SpringBoot 테스트 개선해보기 (feat. mock)</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/en/2024/10/20/spring-batch-jpacursoritemreader#jpa-22-스펙-추가">jpa 2.2 스펙 추가</a></li><li><a class="table-of-contents__link toc-highlight" href="/en/2024/10/20/spring-batch-jpacursoritemreader#hibernate-orm-55">hibernate-orm 5.5</a></li><li><a class="table-of-contents__link toc-highlight" href="/en/2024/10/20/spring-batch-jpacursoritemreader#spring-batch--과거-jpacursoritemreader">spring-batch / 과거 JpaCursorItemReader</a></li><li><a class="table-of-contents__link toc-highlight" href="/en/2024/10/20/spring-batch-jpacursoritemreader#그렇다면-jpacursoritemreader-이제는-정말-괜찮을까">그렇다면, JpaCursorItemReader 이제는 정말 괜찮을까?</a><ul><li><a class="table-of-contents__link toc-highlight" href="/en/2024/10/20/spring-batch-jpacursoritemreader#왜-그런걸까">왜 그런걸까?</a></li><li><a class="table-of-contents__link toc-highlight" href="/en/2024/10/20/spring-batch-jpacursoritemreader#그러면-fetchsize를-어떻게-설정하나">그러면 fetchSize를 어떻게 설정하나..?</a></li><li><a class="table-of-contents__link toc-highlight" href="/en/2024/10/20/spring-batch-jpacursoritemreader#hintsettablejpacursoritemreader-임시-구현-및-결과">HintSettableJpaCursorItemReader 임시 구현 및 결과</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 heowc, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>